#!/bin/bash
set -e

source ${SCRIPTS_DIR}/lib/debug_functions
source ${SCRIPTS_DIR}/lib/version

cd ${DAPPER_SOURCE}

echo Building subctl version $VERSION for ${GOOS:=$(go env GOOS)}/${GOARCH:=$(go env GOARCH)}
GIT_REF="$(git describe --tags)"
ldflags="-X github.com/submariner-io/submariner-operator/pkg/version.Version=${VERSION} "
ldflags="${ldflags} -X github.com/submariner-io/submariner-operator/pkg/version.GitRef=${GIT_REF}"

# OSX does not seem to like upx compressed from linux, so disabled
[ "$GOOS" != "darwin" ] || upxflag="--noupx"

output=bin/subctl-${VERSION}-${GOOS}-${GOARCH}${GOEXE}
${SCRIPTS_DIR}/compile.sh --ldflags "$ldflags" $upxflag $output ./pkg/subctl/main.go "$@"

if [ "${GOARCH}" = "$(GOARCH= go env GOARCH)" ] && [ "${GOOS}" = "$(GOOS= go env GOOS)" ]; then
    ln -sf ${output#bin/} bin/subctl
fi
